#!/usr/bin/env bash

function sed_inplace () {
  # Ref: https://stackoverflow.com/a/4247319
  if [[ $OSTYPE == 'darwin'* ]]; then
    # macOS
    sed -i '' "$@"
  else
    sed -i'' "$@"
  fi
}

command_name="$1"

case $command_name in
  lint)
    ./gradlew clean lint
    ;;
  unit_tests)
    ./gradlew --continue clean testRelease
    ;;
  set_new_version)
    # guard against version updates when CHANGELOG doesn't contain an unreleased section
    grep "## unreleased" CHANGELOG.md || (echo "::error::No unreleased section found in CHANGELOG"; exit 1)

    new_version="$2"
    ./gradlew -PversionParam="${new_version}" changeGradleReleaseVersion
    ./gradlew -PversionParam="${new_version}" changeREADMEVersion
    ./gradlew -PversionParam="${new_version}" changeMigrationGuideVersion
    ./gradlew -PversionParam="${new_version}" updateCHANGELOGVersion
    ;;
  increment_snapshot_version)
    new_version="$2"
    ./gradlew -PversionParam="${new_version}" incrementSNAPSHOTVersion
    ;;
  increment_demo_app_version_code)
    ./gradlew incrementVersionCode
    ;;
esac

